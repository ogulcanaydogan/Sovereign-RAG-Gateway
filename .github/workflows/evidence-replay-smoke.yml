name: evidence-replay-smoke

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  replay-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Install dependencies
        run: uv sync --extra dev
      - name: Generate synthetic audited request
        id: request
        run: |
          uv run python - <<'PY'
          import json
          import os
          from pathlib import Path

          from fastapi.testclient import TestClient

          os.environ["SRG_API_KEYS"] = "test-key"
          os.environ["SRG_OPA_SIMULATE_TIMEOUT"] = "false"
          os.environ["SRG_AUDIT_LOG_PATH"] = "artifacts/audit/evidence-smoke-events.jsonl"

          from app.config.settings import clear_settings_cache
          from app.main import create_app

          clear_settings_cache()
          client = TestClient(create_app())
          response = client.post(
              "/v1/chat/completions",
              headers={
                  "Authorization": "Bearer test-key",
                  "x-srg-tenant-id": "tenant-a",
                  "x-srg-user-id": "smoke-user",
                  "x-srg-classification": "phi",
              },
              json={
                  "model": "gpt-4o-mini",
                  "messages": [{"role": "user", "content": "patient DOB 01/01/1990"}],
              },
          )
          if response.status_code != 200:
              raise SystemExit(f"unexpected status: {response.status_code}")

          audit_path = Path("artifacts/audit/evidence-smoke-events.jsonl")
          rows = [json.loads(line) for line in audit_path.read_text(encoding="utf-8").splitlines() if line.strip()]
          request_id = rows[-1]["request_id"]

          output = Path(os.environ["GITHUB_OUTPUT"])
          with output.open("a", encoding="utf-8") as handle:
              handle.write(f"request_id={request_id}\n")
              handle.write(f"audit_log={audit_path}\n")
          PY
      - name: Build evidence bundle
        run: |
          mkdir -p artifacts/evidence
          openssl genrsa -out artifacts/evidence-private.pem 2048
          openssl rsa -in artifacts/evidence-private.pem -pubout -out artifacts/evidence/public.pem
          uv run python scripts/audit_replay_bundle.py \
            --request-id "${{ steps.request.outputs.request_id }}" \
            --audit-log "${{ steps.request.outputs.audit_log }}" \
            --out-dir artifacts/evidence \
            --include-chain-verify \
            --sign-private-key artifacts/evidence-private.pem \
            --verify-public-key artifacts/evidence/public.pem
          rm -f artifacts/evidence-private.pem
      - name: Validate schemas
        run: uv run python scripts/validate_schemas.py
      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: evidence-replay-artifacts
          path: |
            artifacts/evidence
            artifacts/audit/evidence-smoke-events.jsonl
