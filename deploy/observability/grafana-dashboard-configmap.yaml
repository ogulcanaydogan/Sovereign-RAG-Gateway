apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-srg-dashboard
  namespace: observability
data:
  srg-overview.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "id": 100,
          "title": "Request Overview",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "reqps"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 1},
          "id": 1,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_requests_total[5m])) by (endpoint)", "legendFormat": "{{endpoint}}", "refId": "A"}
          ],
          "title": "Request Rate (by endpoint)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "s"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 1},
          "id": 2,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "histogram_quantile(0.50, sum(rate(srg_request_duration_seconds_bucket[5m])) by (le, endpoint))", "legendFormat": "p50 {{endpoint}}", "refId": "A"},
            {"expr": "histogram_quantile(0.95, sum(rate(srg_request_duration_seconds_bucket[5m])) by (le, endpoint))", "legendFormat": "p95 {{endpoint}}", "refId": "B"},
            {"expr": "histogram_quantile(0.99, sum(rate(srg_request_duration_seconds_bucket[5m])) by (le, endpoint))", "legendFormat": "p99 {{endpoint}}", "refId": "C"}
          ],
          "title": "Request Latency (p50 / p95 / p99)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "short"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 1},
          "id": 3,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_requests_total[5m])) by (status)", "legendFormat": "HTTP {{status}}", "refId": "A"}
          ],
          "title": "Request Rate (by HTTP status)",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 9},
          "id": 101,
          "title": "Policy Decisions",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"fixedColor": "green", "mode": "fixed"}, "unit": "short"},
            "overrides": [
              {"matcher": {"id": "byName", "options": "deny"}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]},
              {"matcher": {"id": "byName", "options": "observe"}, "properties": [{"id": "color", "value": {"fixedColor": "orange", "mode": "fixed"}}]}
            ]
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 10},
          "id": 4,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_policy_decisions_total[5m])) by (decision)", "legendFormat": "{{decision}}", "refId": "A"}
          ],
          "title": "Policy Decision Rate (allow / deny / observe)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"unit": "percentunit", "min": 0, "max": 1, "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.05}, {"color": "red", "value": 0.10}]}},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 10},
          "id": 5,
          "options": {},
          "targets": [
            {"expr": "sum(rate(srg_policy_decisions_total{decision=\"deny\"}[5m])) / sum(rate(srg_policy_decisions_total[5m]))", "refId": "A"}
          ],
          "title": "Policy Deny Rate",
          "type": "gauge"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 18},
          "id": 102,
          "title": "Provider & Cost",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "short"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 19},
          "id": 6,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_tokens_total[5m])) by (provider, direction)", "legendFormat": "{{provider}} {{direction}}", "refId": "A"}
          ],
          "title": "Token Throughput (by provider)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "currencyUSD", "decimals": 4},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 19},
          "id": 7,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(increase(srg_cost_usd_total[1h])) by (provider)", "legendFormat": "{{provider}}", "refId": "A"}
          ],
          "title": "Estimated Cost (hourly, by provider)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "unit": "short"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 19},
          "id": 8,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_provider_fallbacks_total[5m])) by (provider)", "legendFormat": "{{provider}}", "refId": "A"}
          ],
          "title": "Provider Fallback Rate",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 27},
          "id": 103,
          "title": "Data Protection",
          "type": "row"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"color": {"fixedColor": "purple", "mode": "fixed"}, "unit": "short"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 28},
          "id": 9,
          "options": {"legend": {"displayMode": "list", "placement": "bottom"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_redactions_total[5m])) by (endpoint)", "legendFormat": "{{endpoint}}", "refId": "A"}
          ],
          "title": "Redaction Rate (PHI/PII detections)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {"unit": "short"},
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 28},
          "id": 10,
          "options": {"legend": {"displayMode": "table", "placement": "right"}, "tooltip": {"mode": "multi"}},
          "targets": [
            {"expr": "sum(rate(srg_requests_total[5m])) by (provider, model)", "legendFormat": "{{provider}} / {{model}}", "refId": "A"}
          ],
          "title": "Request Distribution (by provider + model)",
          "type": "timeseries"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 39,
      "style": "dark",
      "tags": ["srg", "governance", "rag", "llm"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Sovereign RAG Gateway Overview",
      "version": 1
    }
